<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CM360 Tag Viewer</title>
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: linear-gradient(135deg, #E6F0FA 0%, #F0F6FF 100%); color: #0A1E3F; }
    #leftPanel { width: 50%; height: 100%; padding: 15px; border-right: 2px solid #0055A4; overflow: auto; display: flex; flex-direction: column; background-color: #fff; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
    #creative { flex: 1; border: 1px solid #0055A4; border-radius: 8px; padding: 10px; background-color: #F0F6FF; overflow: auto; }
    #log { width: 50%; height: 100%; padding: 20px; background-color: #F0F6FF; overflow-y: auto; }
    h3 { margin-top: 0; color: #0055A4; font-weight: 600; font-size: 1.4em; margin-bottom: 20px; }
    .pixel-check { font-size: 14px; margin: 8px 0; padding: 8px 12px; border-radius: 6px; border-left: 4px solid; background-color: #fff; }
    .fired { color: #2E7D32; font-weight: 600; border-left-color: #4CAF50; background-color: #E8F5E8; }
    .not-fired { color: #C9302C; border-left-color: #F44336; background-color: #FFEBEE; }
    .pending { color: #FF9800; border-left-color: #FF9800; background-color: #FFF3E0; }
    #backButton { margin-bottom: 12px; padding: 12px 24px; font-size: 14px; cursor: pointer; border: none; border-radius: 8px; background: linear-gradient(135deg, #0055A4 0%, #007ACC 100%); color: #fff; font-weight: 600; transition: all .3s ease; box-shadow: 0 2px 8px rgba(0,85,164,.3); }
    #backButton:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,85,164,.4); }
    .stats { background-color: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #0055A4; }
    .stats-item { display: inline-block; margin-right: 20px; font-weight: 600; }
    .fired-count { color: #2E7D32; } .pending-count { color: #FF9800; } .not-fired-count { color: #C9302C; }
    .network-log { max-height: 260px; overflow-y: auto; background-color: #fff; border: 1px solid #0055A4; border-radius: 8px; padding: 10px; margin-top: 20px; font-family: monospace; font-size: 12px; }
    .network-entry { margin: 2px 0; padding: 2px 4px; border-radius: 3px; }
    .network-success { background-color: #E8F5E8; } .network-error { background-color: #FFEBEE; }
    .network-pixel { background-color: #FFF3E0; border: 1px solid #FF9800; }
    .clear-btn { background: none; border: 1px solid #0055A4; color: #0055A4; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-top: 10px; }
    .clear-btn:hover { background-color: #0055A4; color: #fff; }
  </style>
</head>
<body>
  <div id="leftPanel">
    <button id="backButton" onclick="goBack()">‚Üê Back to Index</button>
    <div id="creative"></div>
  </div>
  <div id="log">
    <h3>Pixel Tracker</h3>
    <div class="stats">
      <span class="stats-item fired-count">‚úÖ Fired: <span id="firedCount">0</span></span>
      <span class="stats-item pending-count">‚è≥ Pending: <span id="pendingCount">0</span></span>
      <span class="stats-item not-fired-count">‚ùå Not Detected: <span id="notFiredCount">0</span></span>
    </div>
    <div id="pixelList"></div>

    <!-- === ID PARSER PANEL === -->
    <div class="id-panel" style="background:#fff;border:1px solid #0055A4;border-radius:8px;padding:12px;margin:20px 0;">
      <h3 style="margin:0 0 8px 0">ID Parser</h3>
      <div style="display:grid;grid-template-columns:140px 1fr auto;gap:8px 10px;align-items:center">
        <div class="id-label" style="font-weight:600;color:#0055A4">Placement ID</div>
        <div class="id-value" id="placementIdValue" style="padding:6px 8px;background:#F0F6FF;border:1px solid #c7dcff;border-radius:6px;min-height:18px;font-family:monospace;font-size:12px"></div>
        <button class="copy-btn" onclick="copyText('placementIdValue')" style="border:1px solid #0055A4;background:#fff;color:#0055A4;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px">Copy</button>

        <div class="id-label" style="font-weight:600;color:#0055A4">Ad ID</div>
        <div class="id-value" id="adIdValue" style="padding:6px 8px;background:#F0F6FF;border:1px solid #c7dcff;border-radius:6px;min-height:18px;font-family:monospace;font-size:12px"></div>
        <button class="copy-btn" onclick="copyText('adIdValue')" style="border:1px solid #0055A4;background:#fff;color:#0055A4;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px">Copy</button>

        <div class="id-label" style="font-weight:600;color:#0055A4">Creative ID</div>
        <div class="id-value" id="creativeIdValue" style="padding:6px 8px;background:#F0F6FF;border:1px solid #c7dcff;border-radius:6px;min-height:18px;font-family:monospace;font-size:12px"></div>
        <button class="copy-btn" onclick="copyText('creativeIdValue')" style="border:1px solid #0055A4;background:#fff;color:#0055A4;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px">Copy</button>
      </div>
      <div id="idParserNotes" style="font-size:11px;color:#233;margin-top:8px;opacity:.8"></div>
    </div>

    <h3>Network Activity</h3>
    <button class="clear-btn" onclick="clearNetworkLog()">Clear Log</button>
    <div id="networkLog" class="network-log"></div>
  </div>

  <script>
    // ---- Expected pixels list (unchanged) ----
    const expectedPixels = [
      { name: "CM360/DoubleClick", patterns: ["doubleclick.net", "googleadservices.com", "googlesyndication.com", "dcmads.js", "fls.doubleclick.net"] },
      { name: "LiveRamp", patterns: ["di.rlcdn.com", "liveramp.com"] },
      { name: "Connect", patterns: ["hrzn-nxt.com", "horizon-nxt.com"] },
      { name: "Meta/Facebook", patterns: ["facebook.com/tr", "connect.facebook.net"] },
      { name: "Google Ads", patterns: ["googleads.g.doubleclick.net", "google-analytics.com", "googletagmanager.com"] },
      { name: "DoubleVerify", patterns: ["cdn.doubleverify.com"] },
      { name: "iSpot", patterns: ["ispot.tv/"] },
      { name: "Generic Pixel", patterns: [".gif", ".png", ".jpg", "pixel", "tracking"] }
    ];

    // ---- Pixel status helpers (unchanged) ----
    const pixelStatus = {};
    const networkLog = [];
    let networkLogElement, pixelListElement;

    function initializePixelTracking() {
      pixelListElement = document.getElementById("pixelList");
      networkLogElement = document.getElementById("networkLog");
      expectedPixels.forEach(pixel => {
        pixelStatus[pixel.name] = 'not-fired';
        const el = document.createElement("div");
        el.className = "pixel-check not-fired";
        el.id = `pixel-${pixel.name.replace(/[^a-zA-Z0-9]/g, '')}`;
        el.textContent = `‚ùå ${pixel.name}: Not detected`;
        pixelListElement.appendChild(el);
      });
      updateStats();
    }

    function markPixelFired(name, url) {
      if (pixelStatus[name] !== 'fired') {
        pixelStatus[name] = 'fired';
        const el = document.getElementById(`pixel-${name.replace(/[^a-zA-Z0-9]/g, '')}`);
        if (el) { el.className = "pixel-check fired"; el.textContent = `‚úÖ ${name}: Detected`; }
        logPixelDetection(name, url);
        updateStats();
      }
    }

    function markPixelPending(name) {
      if (pixelStatus[name] === 'not-fired') {
        pixelStatus[name] = 'pending';
        const el = document.getElementById(`pixel-${name.replace(/[^a-zA-Z0-9]/g, '')}`);
        if (el) { el.className = "pixel-check pending"; el.textContent = `‚è≥ ${name}: Loading...`; }
        updateStats();
      }
    }

    function updateStats() {
      const vals = Object.values(pixelStatus);
      document.getElementById('firedCount').textContent = vals.filter(s => s === 'fired').length;
      document.getElementById('pendingCount').textContent = vals.filter(s => s === 'pending').length;
      document.getElementById('notFiredCount').textContent = vals.filter(s => s === 'not-fired').length;
    }

    function logNetworkActivity(url, status, description) {
      const timestamp = new Date().toLocaleTimeString();
      networkLog.push({ timestamp, url, status, description });
      const logEntry = document.createElement('div');
      logEntry.className = `network-entry network-${status}`;
      logEntry.textContent = `[${timestamp}] ${description}: ${url}`;
      networkLogElement.appendChild(logEntry);
      networkLogElement.scrollTop = networkLogElement.scrollHeight;
      // detect after logging
      setTimeout(() => checkPixelUrl(url), 0);

      // --- NEW: ID parser hook ---
      updateIdsFromUrl(url);
    }

    function logPixelDetection(name, url) {
      const timestamp = new Date().toLocaleTimeString();
      networkLog.push({ timestamp, url, status: 'pixel', description: `${name} PIXEL FIRED` });
      const logEntry = document.createElement('div');
      logEntry.className = 'network-entry network-pixel';
      logEntry.textContent = `[${timestamp}] üéØ ${name} PIXEL FIRED: ${url}`;
      networkLogElement.appendChild(logEntry);
      networkLogElement.scrollTop = networkLogElement.scrollHeight;
    }

    function clearNetworkLog() { networkLog.length = 0; networkLogElement.innerHTML = ''; }

    // ---- Pixel URL matcher (unchanged) ----
    function checkPixelUrl(url) {
      if (!url || typeof url !== 'string') return;
      let full = "", host = "";
      try {
        const u = new URL(url, window.location.href);
        full = u.href.toLowerCase();
        host = u.hostname.toLowerCase();
      } catch { full = String(url).toLowerCase(); }
      expectedPixels.forEach(pixel => {
        const hit = pixel.patterns.some(pat => {
          const p = String(pat).toLowerCase().trim();
          if (p.includes(".") && !p.startsWith("/") && host) {
            if (host === p || host.endsWith("." + p)) return true;
          }
          return full.includes(p);
        });
        if (hit) markPixelFired(pixel.name, url);
      });
    }

    function goBack() { window.location.href = "index.html"; }
    window.goBack = goBack;

    // === Minimal ID Parser ===
    const idState = { placementId: null, adId: null, creativeId: null };
    function setIdValue(elId, val){ const el=document.getElementById(elId); if(el) el.textContent = val || ''; }
    function copyText(elId){ const el=document.getElementById(elId); const txt=el?.textContent?.trim(); if(txt) navigator.clipboard?.writeText(txt); }
    window.copyText = copyText;
    function parseQuery(url) { try { const u = new URL(url, location.href); return Object.fromEntries(u.searchParams.entries()); } catch { return {}; } }
    function noteId(msg){ const el=document.getElementById('idParserNotes'); if(!el) return; el.innerHTML += (el.innerHTML ? '<br>' : '') + '‚Ä¢ ' + msg; }
    function shorten(u){ try{ const x=new URL(u, location.href); return x.hostname + x.pathname.slice(0,40); }catch{ return String(u).slice(0,60); } }
    function updateIdsFromUrl(url) {
      if (!url || url === '(unknown)' || url === '(none)') return;
      const q = parseQuery(url);
      const k = Object.fromEntries(Object.entries(q).map(([a,b]) => [a.toLowerCase(), String(b)]));
      const pl = k.placementid || k.plid || k.placement || null;
      const ad = k.adid || k.ad || k.ad_id || null;
      const cr = k.crid || k.creative || k.creativeid || k.cid || null;
      if (pl && !idState.placementId) { idState.placementId = pl; setIdValue('placementIdValue', pl); noteId(`Placement ID from ${shorten(url)}`); }
      if (ad && !idState.adId)        { idState.adId        = ad; setIdValue('adIdValue', ad);       noteId(`Ad ID from ${shorten(url)}`); }
      if (cr && !idState.creativeId)  { idState.creativeId  = cr; setIdValue('creativeIdValue', cr);  noteId(`Creative ID from ${shorten(url)}`); }
    }

    // === Creative sandbox loader (RESTORED) ===
    function runTagInSandbox(tagContent) {
      const creativeDiv = document.getElementById("creative");

      const wrapper = document.createElement('div');
      wrapper.style.cssText = 'border:2px dashed #0055A4;padding:10px;margin-top:10px;border-radius:8px;';
      wrapper.innerHTML = '<strong>CM360 Creative Sandbox:</strong><br><br>';
      creativeDiv.appendChild(wrapper);

      const iframe = document.createElement('iframe');
      iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-popups';
      iframe.style.width = '300px';
      iframe.style.height = '250px';
      iframe.style.border = '1px solid #ccc';
      wrapper.appendChild(iframe);

      // Load the tag content inside the iframe
      iframe.srcdoc = `
        <!doctype html>
        <html>
          <head><meta charset="utf-8"></head>
          <body>${tagContent}</body>
        </html>
      `;

      iframe.onload  = () => {
        logNetworkActivity('sandbox','success','Sandbox iframe loaded');
        wrapper.style.border='2px solid #4CAF50';
        wrapper.querySelector('strong').textContent='CM360 Creative Sandbox (Loaded):';
      };
      iframe.onerror = () => {
        logNetworkActivity('sandbox','error','Sandbox iframe failed to load');
        wrapper.style.border='2px solid #F44336';
        wrapper.querySelector('strong').textContent='CM360 Creative Sandbox (Error):';
      };
    }

    // ---- Boot (unchanged except for parser pre-seed optional) ----
    initializePixelTracking();
    const params = new URLSearchParams(window.location.search);
    const rawTag = decodeURIComponent(params.get("tag") || "");
    const header = document.createElement('div');
    header.style.cssText = 'background:#E6F0FA;border:1px solid #0055A4;padding:12px;border-radius:6px;margin-bottom:15px;font-weight:600;';
    header.textContent = params.get("tag") ? '‚úÖ Tag parameter detected - initializing sandbox...' : '‚ùå No tag parameter found in URL.';
    document.getElementById("creative").appendChild(header);

    if (rawTag && rawTag.trim()) {
      expectedPixels.forEach(p => markPixelPending(p.name));
      runTagInSandbox(rawTag);
      setTimeout(() => {
        expectedPixels.forEach(pixel => {
          if (pixelStatus[pixel.name] === 'pending') {
            pixelStatus[pixel.name] = 'not-fired';
            const el = document.getElementById(`pixel-${pixel.name.replace(/[^a-zA-Z0-9]/g, '')}`);
            if (el) { el.className = "pixel-check not-fired"; el.textContent = `‚ùå ${pixel.name}: Timeout (no activity detected)`; }
          }
        });
        updateStats();
        logNetworkActivity('timeout','error','Pixel detection timeout reached');
      }, 12000);
    } else {
      document.getElementById("creative").innerHTML += "<p style='color:#C9302C; text-align:center; padding:20px;'>‚ùå No tag content received or tag is empty.</p>";
    }
  </script>
</body>
</html>
