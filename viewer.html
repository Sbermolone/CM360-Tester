<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CM360 Tag Viewer</title>
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Segoe UI', sans-serif; 
      margin: 0; 
      display: flex; 
      height: 100vh; 
      background: linear-gradient(135deg, #E6F0FA 0%, #F0F6FF 100%);
      color: #0A1E3F;
    }
    #leftPanel {
      width: 50%; 
      height: 100%; 
      padding: 15px; 
      border-right: 2px solid #0055A4; 
      overflow: auto; 
      display: flex; 
      flex-direction: column;
      background-color: #ffffff;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    #creative { 
      flex: 1; 
      border: 1px solid #0055A4;
      border-radius: 8px;
      padding: 10px;
      background-color: #F0F6FF;
      overflow: auto;
    }
    #log { 
      width: 50%; 
      height: 100%; 
      padding: 20px; 
      background-color: #F0F6FF; 
      overflow-y: auto;
    }
    h3 { 
      margin-top: 0; 
      color: #0055A4; 
      font-weight: 600;
      font-size: 1.4em;
      margin-bottom: 20px;
    }
    .pixel-check { 
      font-size: 14px; 
      margin: 8px 0; 
      padding: 8px 12px;
      border-radius: 6px;
      border-left: 4px solid;
      background-color: #ffffff;
    }
    .fired { 
      color: #2E7D32; 
      font-weight: 600;
      border-left-color: #4CAF50;
      background-color: #E8F5E8;
    }
    .not-fired { 
      color: #C9302C;
      border-left-color: #F44336;
      background-color: #FFEBEE;
    }
    .pending {
      color: #FF9800;
      border-left-color: #FF9800;
      background-color: #FFF3E0;
    }
    #backButton {
      margin-bottom: 12px; 
      padding: 12px 24px; 
      font-size: 14px; 
      cursor: pointer; 
      border: none; 
      border-radius: 8px; 
      background: linear-gradient(135deg, #0055A4 0%, #007ACC 100%);
      color: #fff; 
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 85, 164, 0.3);
    }
    #backButton:hover { 
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 85, 164, 0.4);
    }
    .stats {
      background-color: #ffffff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #0055A4;
    }
    .stats-item {
      display: inline-block;
      margin-right: 20px;
      font-weight: 600;
    }
    .fired-count { color: #2E7D32; }
    .pending-count { color: #FF9800; }
    .not-fired-count { color: #C9302C; }
    .network-log {
      max-height: 200px;
      overflow-y: auto;
      background-color: #ffffff;
      border: 1px solid #0055A4;
      border-radius: 8px;
      padding: 10px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 12px;
    }
    .network-entry {
      margin: 2px 0;
      padding: 2px 4px;
      border-radius: 3px;
    }
    .network-success { background-color: #E8F5E8; }
    .network-error { background-color: #FFEBEE; }
    .clear-btn {
      background: none;
      border: 1px solid #0055A4;
      color: #0055A4;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      margin-top: 10px;
    }
    .clear-btn:hover {
      background-color: #0055A4;
      color: white;
    }
  </style>
</head>
<body>
  <div id="leftPanel">
    <button id="backButton" onclick="goBack()">← Back to Index</button>
    <div id="creative"></div>
  </div>
  <div id="log">
    <h3>Pixel Tracker</h3>
    <div class="stats">
      <span class="stats-item fired-count">✅ Fired: <span id="firedCount">0</span></span>
      <span class="stats-item pending-count">⏳ Pending: <span id="pendingCount">0</span></span>
      <span class="stats-item not-fired-count">❌ Not Detected: <span id="notFiredCount">0</span></span>
    </div>
    <div id="pixelList"></div>
    
    <h3>Network Activity</h3>
    <button class="clear-btn" onclick="clearNetworkLog()">Clear Log</button>
    <div id="networkLog" class="network-log"></div>
  </div>

  <script>
    const expectedPixels = [
      { name: "CM360/DoubleClick", patterns: ["doubleclick.net", "googleadservices.com", "googlesyndication.com", "dcmads.js", "fls.doubleclick.net"] },
      { name: "LiveRamp", patterns: ["di.rlcdn.com", "liveramp.com"] },
      { name: "Connect", patterns: ["hrzn-nxt.com", "horizon-nxt.com"] },
      { name: "Meta/Facebook", patterns: ["facebook.com/tr", "connect.facebook.net"] },
      { name: "Google Ads", patterns: ["googleads.g.doubleclick.net", "google-analytics.com", "googletagmanager.com"] },
      { name: "Generic Pixel", patterns: [".gif", ".png", ".jpg", "pixel", "tracking"] }
    ];

    const pixelStatus = {};
    const networkLog = [];
    let networkLogElement, pixelListElement;

    function initializePixelTracking() {
      pixelListElement = document.getElementById("pixelList");
      networkLogElement = document.getElementById("networkLog");
      
      expectedPixels.forEach(pixel => {
        pixelStatus[pixel.name] = 'not-fired';
        const el = document.createElement("div");
        el.className = "pixel-check not-fired";
        el.id = `pixel-${pixel.name.replace(/[^a-zA-Z0-9]/g, '')}`;
        el.textContent = `❌ ${pixel.name}: Not detected`;
        pixelListElement.appendChild(el);
      });
      
      updateStats();
    }

    function markPixelFired(name, url) {
      if (pixelStatus[name] !== 'fired') {
        pixelStatus[name] = 'fired';
        const el = document.getElementById(`pixel-${name.replace(/[^a-zA-Z0-9]/g, '')}`);
        if (el) {
          el.className = "pixel-check fired";
          el.textContent = `✅ ${name}: Detected`;
        }
        logNetworkActivity(url, 'success', `${name} pixel detected`);
        updateStats();
      }
    }

    function markPixelPending(name) {
      if (pixelStatus[name] === 'not-fired') {
        pixelStatus[name] = 'pending';
        const el = document.getElementById(`pixel-${name.replace(/[^a-zA-Z0-9]/g, '')}`);
        if (el) {
          el.className = "pixel-check pending";
          el.textContent = `⏳ ${name}: Loading...`;
        }
        updateStats();
      }
    }

    function updateStats() {
      const fired = Object.values(pixelStatus).filter(s => s === 'fired').length;
      const pending = Object.values(pixelStatus).filter(s => s === 'pending').length;
      const notFired = Object.values(pixelStatus).filter(s => s === 'not-fired').length;
      
      document.getElementById('firedCount').textContent = fired;
      document.getElementById('pendingCount').textContent = pending;
      document.getElementById('notFiredCount').textContent = notFired;
    }

    function logNetworkActivity(url, status, description) {
      const timestamp = new Date().toLocaleTimeString();
      const entry = { timestamp, url, status, description };
      networkLog.push(entry);
      
      const logEntry = document.createElement('div');
      logEntry.className = `network-entry network-${status}`;
      logEntry.textContent = `[${timestamp}] ${description}: ${url}`;
      networkLogElement.appendChild(logEntry);
      networkLogElement.scrollTop = networkLogElement.scrollHeight;
    }

    function clearNetworkLog() {
      networkLog.length = 0;
      networkLogElement.innerHTML = '';
    }

    // Monitor network requests
    function setupNetworkMonitoring() {
      // Monitor image loads
      const originalImage = Image;
      window.Image = function() {
        const img = new originalImage();
        const originalSrc = img.src;
        
        Object.defineProperty(img, 'src', {
          set: function(value) {
            checkPixelUrl(value);
            originalImage.prototype.src = value;
            img.onload = function() {
              logNetworkActivity(value, 'success', 'Image loaded');
            };
            img.onerror = function() {
              logNetworkActivity(value, 'error', 'Image failed to load');
            };
            return true;
          },
          get: function() {
            return originalSrc;
          }
        });
        
        return img;
      };

      // Monitor iframe loads  
      const iframes = document.querySelectorAll('iframe');
      iframes.forEach(iframe => {
        const src = iframe.src;
        if (src) {
          checkPixelUrl(src);
          logNetworkActivity(src, 'success', 'Iframe loaded');
        }
      });

      // Monitor script loads
      const scripts = document.querySelectorAll('script[src]');
      scripts.forEach(script => {
        const src = script.src;
        if (src) {
          checkPixelUrl(src);
          logNetworkActivity(src, 'success', 'Script loaded');
        }
      });
    }

    function checkPixelUrl(url) {
      expectedPixels.forEach(pixel => {
        pixel.patterns.forEach(pattern => {
          if (url.includes(pattern)) {
            markPixelFired(pixel.name, url);
          }
        });
      });
    }

    function scanExistingElements() {
      // Check all images
      document.querySelectorAll('img').forEach(img => {
        if (img.src) checkPixelUrl(img.src);
      });
      
      // Check all iframes
      document.querySelectorAll('iframe').forEach(iframe => {
        if (iframe.src) checkPixelUrl(iframe.src);
      });
      
      // Check all scripts
      document.querySelectorAll('script[src]').forEach(script => {
        if (script.src) checkPixelUrl(script.src);
      });
    }

    // Initialize
    initializePixelTracking();

    // Load and execute the tag
    const params = new URLSearchParams(window.location.search);
    const rawTag = decodeURIComponent(params.get("tag") || "");
    
    if (rawTag) {
      const creativeDiv = document.getElementById("creative");
      
      // Debug: Show what we're trying to load
      console.log("Loading tag:", rawTag);
      logNetworkActivity(window.location.href, 'success', 'Tag received for processing');
      
      // Set up monitoring before loading the tag
      setupNetworkMonitoring();
      
      // Create a safe way to inject and execute the tag
      function loadTag(tagContent) {
        // For CM360 tags with dcmads.js, we need special handling
        if (tagContent.includes('dcmads.js') || tagContent.includes('class=\'dcmads\'')) {
          logNetworkActivity('CM360', 'success', 'Detected CM360 dcmads tag format');
          
          // Insert the tag content first
          creativeDiv.innerHTML = tagContent;
          
          // Wait a moment for the dcmads.js to load and process
          setTimeout(() => {
            // Check if the iframe was created
            const dcmIframe = creativeDiv.querySelector('iframe');
            if (dcmIframe) {
              logNetworkActivity(dcmIframe.src || 'iframe', 'success', 'CM360 creative iframe created');
              
              // Monitor the iframe source for pixel patterns
              if (dcmIframe.src) {
                checkPixelUrl(dcmIframe.src);
              }
              
              // Listen for iframe load
              dcmIframe.onload = function() {
                logNetworkActivity(dcmIframe.src, 'success', 'CM360 creative iframe loaded');
                try {
                  // Try to access iframe content for additional monitoring
                  // Note: This will likely fail due to CORS, but worth trying
                  if (dcmIframe.contentDocument) {
                    const iframeScripts = dcmIframe.contentDocument.querySelectorAll('script[src]');
                    const iframeImages = dcmIframe.contentDocument.querySelectorAll('img[src]');
                    
                    iframeScripts.forEach(script => checkPixelUrl(script.src));
                    iframeImages.forEach(img => checkPixelUrl(img.src));
                  }
                } catch (e) {
                  // Expected - cross-origin iframe content not accessible
                  logNetworkActivity('iframe-content', 'error', 'Cannot access iframe content (CORS)');
                }
              };
            } else {
              // If no iframe found, check for other elements that might have been created
              logNetworkActivity('CM360', 'error', 'No iframe found after dcmads.js execution');
              scanExistingElements();
            }
          }, 2000); // Wait 2 seconds for dcmads.js to work
          
        } else if (tagContent.includes('<script')) {
          // Handle other script-based tags
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = tagContent;
          
          // Move all content to the creative div
          while (tempDiv.firstChild) {
            const child = tempDiv.firstChild;
            if (child.tagName === 'SCRIPT') {
              // Create new script element to ensure execution
              const newScript = document.createElement('script');
              if (child.src) {
                newScript.src = child.src;
                newScript.async = child.async;
                newScript.defer = child.defer;
                newScript.onload = () => logNetworkActivity(child.src, 'success', 'External script loaded');
                newScript.onerror = () => logNetworkActivity(child.src, 'error', 'External script failed to load');
              } else {
                newScript.textContent = child.textContent;
              }
              creativeDiv.appendChild(newScript);
              logNetworkActivity(child.src || 'inline', 'success', 'Script tag processed');
            } else {
              creativeDiv.appendChild(child);
            }
            tempDiv.removeChild(tempDiv.firstChild);
          }
        } else {
          // For non-script content, direct innerHTML works
          creativeDiv.innerHTML = tagContent;
        }
        
        logNetworkActivity('DOM', 'success', 'Creative content loaded into DOM');
      }
      
      // Load the tag
      try {
        loadTag(rawTag);
        
        // Show a status message
        const statusDiv = document.createElement('div');
        statusDiv.style.cssText = 'background: #E8F5E8; border: 1px solid #4CAF50; padding: 10px; margin-bottom: 10px; border-radius: 5px; color: #2E7D32;';
        statusDiv.textContent = '✅ Tag loaded successfully';
        creativeDiv.insertBefore(statusDiv, creativeDiv.firstChild);
        
      } catch (error) {
        console.error("Error loading tag:", error);
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'background: #FFEBEE; border: 1px solid #F44336; padding: 10px; border-radius: 5px; color: #C9302C;';
        errorDiv.innerHTML = `❌ Error loading tag: ${error.message}<br><br><strong>Tag content:</strong><br><pre style="white-space: pre-wrap; font-size: 12px;">${rawTag}</pre>`;
        creativeDiv.appendChild(errorDiv);
        logNetworkActivity('Error', 'error', `Tag loading failed: ${error.message}`);
      }
      
      // Scan for existing elements after a short delay
      setTimeout(() => {
        scanExistingElements();
        
        // Mark any remaining as not fired after 5 seconds
        setTimeout(() => {
          expectedPixels.forEach(pixel => {
            if (pixelStatus[pixel.name] === 'pending') {
              pixelStatus[pixel.name] = 'not-fired';
              const el = document.getElementById(`pixel-${pixel.name.replace(/[^a-zA-Z0-9]/g, '')}`);
              if (el) {
                el.className = "pixel-check not-fired";
                el.textContent = `❌ ${pixel.name}: Timeout/Not detected`;
              }
            }
          });
          updateStats();
        }, 5000);
      }, 1000);
      
    } else {
      document.getElementById("creative").innerHTML = "<p style='color: #C9302C; text-align: center; padding: 20px;'>❌ No tag provided in URL parameters.</p>";
    }

    function goBack() { 
      window.location.href = "index.html"; 
    }

    // Monitor for dynamically created elements
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        mutation.addedNodes.forEach(function(node) {
          if (node.nodeType === 1) { // Element node
            if (node.tagName === 'IMG' && node.src) {
              checkPixelUrl(node.src);
            } else if (node.tagName === 'IFRAME' && node.src) {
              checkPixelUrl(node.src);
            } else if (node.tagName === 'SCRIPT' && node.src) {
              checkPixelUrl(node.src);
            }
            
            // Check child elements too
            const imgs = node.querySelectorAll ? node.querySelectorAll('img[src]') : [];
            const iframes = node.querySelectorAll ? node.querySelectorAll('iframe[src]') : [];
            const scripts = node.querySelectorAll ? node.querySelectorAll('script[src]') : [];
            
            imgs.forEach(img => checkPixelUrl(img.src));
            iframes.forEach(iframe => checkPixelUrl(iframe.src));
            scripts.forEach(script => checkPixelUrl(script.src));
          }
        });
      });
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  </script>
</body>
</html>
