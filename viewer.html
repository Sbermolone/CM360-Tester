<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CM360 Tag Viewer</title>
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Segoe UI', sans-serif; 
      margin: 0; 
      display: flex; 
      height: 100vh; 
      background: linear-gradient(135deg, #E6F0FA 0%, #F0F6FF 100%);
      color: #0A1E3F;
    }
    #leftPanel {
      width: 50%; 
      height: 100%; 
      padding: 15px; 
      border-right: 2px solid #0055A4; 
      overflow: auto; 
      display: flex; 
      flex-direction: column;
      background-color: #ffffff;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    #creative { 
      flex: 1; 
      border: 1px solid #0055A4;
      border-radius: 8px;
      padding: 10px;
      background-color: #F0F6FF;
      overflow: auto;
    }
    #log { 
      width: 50%; 
      height: 100%; 
      padding: 20px; 
      background-color: #F0F6FF; 
      overflow-y: auto;
    }
    h3 { 
      margin-top: 0; 
      color: #0055A4; 
      font-weight: 600;
      font-size: 1.4em;
      margin-bottom: 20px;
    }
    .pixel-check { 
      font-size: 14px; 
      margin: 8px 0; 
      padding: 8px 12px;
      border-radius: 6px;
      border-left: 4px solid;
      background-color: #ffffff;
    }
    .fired { 
      color: #2E7D32; 
      font-weight: 600;
      border-left-color: #4CAF50;
      background-color: #E8F5E8;
    }
    .not-fired { 
      color: #C9302C;
      border-left-color: #F44336;
      background-color: #FFEBEE;
    }
    .pending {
      color: #FF9800;
      border-left-color: #FF9800;
      background-color: #FFF3E0;
    }
    #backButton {
      margin-bottom: 12px; 
      padding: 12px 24px; 
      font-size: 14px; 
      cursor: pointer; 
      border: none; 
      border-radius: 8px; 
      background: linear-gradient(135deg, #0055A4 0%, #007ACC 100%);
      color: #fff; 
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 85, 164, 0.3);
    }
    #backButton:hover { 
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 85, 164, 0.4);
    }
    .stats {
      background-color: #ffffff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #0055A4;
    }
    .stats-item {
      display: inline-block;
      margin-right: 20px;
      font-weight: 600;
    }
    .fired-count { color: #2E7D32; }
    .pending-count { color: #FF9800; }
    .not-fired-count { color: #C9302C; }
    .network-log {
      max-height: 200px;
      overflow-y: auto;
      background-color: #ffffff;
      border: 1px solid #0055A4;
      border-radius: 8px;
      padding: 10px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 12px;
    }
    .network-entry {
      margin: 2px 0;
      padding: 2px 4px;
      border-radius: 3px;
    }
    .network-success { background-color: #E8F5E8; }
    .network-error { background-color: #FFEBEE; }
    .clear-btn {
      background: none;
      border: 1px solid #0055A4;
      color: #0055A4;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      margin-top: 10px;
    }
    .clear-btn:hover {
      background-color: #0055A4;
      color: white;
    }
  </style>
</head>
<body>
  <div id="leftPanel">
    <button id="backButton" onclick="goBack()">← Back to Index</button>
    <div id="creative"></div>
  </div>
  <div id="log">
    <h3>Pixel Tracker</h3>
    <div class="stats">
      <span class="stats-item fired-count">✅ Fired: <span id="firedCount">0</span></span>
      <span class="stats-item pending-count">⏳ Pending: <span id="pendingCount">0</span></span>
      <span class="stats-item not-fired-count">❌ Not Detected: <span id="notFiredCount">0</span></span>
    </div>
    <div id="pixelList"></div>
    
    <h3>Network Activity</h3>
    <button class="clear-btn" onclick="clearNetworkLog()">Clear Log</button>
    <div id="networkLog" class="network-log"></div>
  </div>

  <script>
    const expectedPixels = [
      { name: "CM360/DoubleClick", patterns: ["doubleclick.net", "googleadservices.com", "googlesyndication.com", "dcmads.js", "fls.doubleclick.net"] },
      { name: "LiveRamp", patterns: ["di.rlcdn.com", "liveramp.com"] },
      { name: "Connect", patterns: ["hrzn-nxt.com", "horizon-nxt.com"] },
      { name: "Meta/Facebook", patterns: ["facebook.com/tr", "connect.facebook.net"] },
      { name: "Google Ads", patterns: ["googleads.g.doubleclick.net", "google-analytics.com", "googletagmanager.com"] },
      { name: "Generic Pixel", patterns: [".gif", ".png", ".jpg", "pixel", "tracking"] }
    ];

    const pixelStatus = {};
    const networkLog = [];
    let networkLogElement, pixelListElement;

    function initializePixelTracking() {
      pixelListElement = document.getElementById("pixelList");
      networkLogElement = document.getElementById("networkLog");
      
      expectedPixels.forEach(pixel => {
        pixelStatus[pixel.name] = 'not-fired';
        const el = document.createElement("div");
        el.className = "pixel-check not-fired";
        el.id = `pixel-${pixel.name.replace(/[^a-zA-Z0-9]/g, '')}`;
        el.textContent = `❌ ${pixel.name}: Not detected`;
        pixelListElement.appendChild(el);
      });
      
      updateStats();
    }

    function markPixelFired(name, url) {
      if (pixelStatus[name] !== 'fired') {
        pixelStatus[name] = 'fired';
        const el = document.getElementById(`pixel-${name.replace(/[^a-zA-Z0-9]/g, '')}`);
        if (el) {
          el.className = "pixel-check fired";
          el.textContent = `✅ ${name}: Detected`;
        }
        logNetworkActivity(url, 'success', `${name} pixel detected`);
        updateStats();
      }
    }

    function markPixelPending(name) {
      if (pixelStatus[name] === 'not-fired') {
        pixelStatus[name] = 'pending';
        const el = document.getElementById(`pixel-${name.replace(/[^a-zA-Z0-9]/g, '')}`);
        if (el) {
          el.className = "pixel-check pending";
          el.textContent = `⏳ ${name}: Loading...`;
        }
        updateStats();
      }
    }

    function updateStats() {
      const fired = Object.values(pixelStatus).filter(s => s === 'fired').length;
      const pending = Object.values(pixelStatus).filter(s => s === 'pending').length;
      const notFired = Object.values(pixelStatus).filter(s => s === 'not-fired').length;
      
      document.getElementById('firedCount').textContent = fired;
      document.getElementById('pendingCount').textContent = pending;
      document.getElementById('notFiredCount').textContent = notFired;
    }

    function logNetworkActivity(url, status, description) {
      const timestamp = new Date().toLocaleTimeString();
      const entry = { timestamp, url, status, description };
      networkLog.push(entry);
      
      const logEntry = document.createElement('div');
      logEntry.className = `network-entry network-${status}`;
      logEntry.textContent = `[${timestamp}] ${description}: ${url}`;
      networkLogElement.appendChild(logEntry);
      networkLogElement.scrollTop = networkLogElement.scrollHeight;
    }

    function clearNetworkLog() {
      networkLog.length = 0;
      networkLogElement.innerHTML = '';
    }

    // Monitor network requests more comprehensively
    function setupNetworkMonitoring() {
      // Override fetch to monitor API calls
      const originalFetch = window.fetch;
      window.fetch = function(...args) {
        const url = args[0];
        logNetworkActivity(url, 'success', 'Fetch request initiated');
        checkPixelUrl(url);
        return originalFetch.apply(this, args)
          .then(response => {
            if (response.ok) {
              logNetworkActivity(url, 'success', 'Fetch request successful');
            } else {
              logNetworkActivity(url, 'error', `Fetch request failed: ${response.status}`);
            }
            return response;
          })
          .catch(error => {
            logNetworkActivity(url, 'error', `Fetch request error: ${error.message}`);
            throw error;
          });
      };

      // Override XMLHttpRequest to monitor AJAX calls
      const originalXHR = window.XMLHttpRequest;
      window.XMLHttpRequest = function() {
        const xhr = new originalXHR();
        const originalOpen = xhr.open;
        
        xhr.open = function(method, url, ...args) {
          logNetworkActivity(url, 'success', `XHR ${method} request initiated`);
          checkPixelUrl(url);
          return originalOpen.apply(this, [method, url, ...args]);
        };
        
        xhr.addEventListener('load', function() {
          if (xhr.status >= 200 && xhr.status < 300) {
            logNetworkActivity(xhr.responseURL || 'XHR', 'success', `XHR request successful (${xhr.status})`);
          } else {
            logNetworkActivity(xhr.responseURL || 'XHR', 'error', `XHR request failed (${xhr.status})`);
          }
        });
        
        xhr.addEventListener('error', function() {
          logNetworkActivity(xhr.responseURL || 'XHR', 'error', 'XHR request error');
        });
        
        return xhr;
      };

      // Monitor image loads more thoroughly
      const originalImage = window.Image;
      window.Image = function() {
        const img = new originalImage();
        
        Object.defineProperty(img, 'src', {
          set: function(value) {
            logNetworkActivity(value, 'success', 'Image src set');
            checkPixelUrl(value);
            
            // Set up load/error handlers
            img.onload = function() {
              logNetworkActivity(value, 'success', 'Image loaded successfully');
            };
            img.onerror = function() {
              logNetworkActivity(value, 'error', 'Image failed to load');
            };
            
            // Actually set the src
            originalImage.prototype.src = value;
          },
          get: function() {
            return originalImage.prototype.src;
          }
        });
        
        return img;
      };

      // Monitor dynamic script additions
      const originalAppendChild = Node.prototype.appendChild;
      Node.prototype.appendChild = function(child) {
        if (child.tagName === 'SCRIPT' && child.src) {
          logNetworkActivity(child.src, 'success', 'Dynamic script added');
          checkPixelUrl(child.src);
        } else if (child.tagName === 'IMG' && child.src) {
          logNetworkActivity(child.src, 'success', 'Dynamic image added');
          checkPixelUrl(child.src);
        } else if (child.tagName === 'IFRAME' && child.src) {
          logNetworkActivity(child.src, 'success', 'Dynamic iframe added');
          checkPixelUrl(child.src);
        }
        return originalAppendChild.call(this, child);
      };
    }

    function checkPixelUrl(url) {
      expectedPixels.forEach(pixel => {
        pixel.patterns.forEach(pattern => {
          if (url.includes(pattern)) {
            markPixelFired(pixel.name, url);
          }
        });
      });
    }

    function scanExistingElements() {
      // Check all images
      document.querySelectorAll('img').forEach(img => {
        if (img.src) checkPixelUrl(img.src);
      });
      
      // Check all iframes
      document.querySelectorAll('iframe').forEach(iframe => {
        if (iframe.src) checkPixelUrl(iframe.src);
      });
      
      // Check all scripts
      document.querySelectorAll('script[src]').forEach(script => {
        if (script.src) checkPixelUrl(script.src);
      });
    }

    // Initialize
    initializePixelTracking();

    // Load and execute the tag
    const params = new URLSearchParams(window.location.search);
    const rawTag = decodeURIComponent(params.get("tag") || "");
    
    // Debug: Always show what we received
    const debugDiv = document.createElement('div');
    debugDiv.style.cssText = 'background: #F0F6FF; border: 1px solid #0055A4; padding: 15px; margin-bottom: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 200px; overflow-y: auto;';
    debugDiv.innerHTML = `<strong>Debug Info:</strong><br>URL Tag Parameter: ${params.get("tag") ? "Found" : "Missing"}<br>Raw Tag Length: ${rawTag.length}<br><br><strong>Tag Content:</strong><br>${rawTag || "No tag content received"}`;
    document.getElementById("creative").appendChild(debugDiv);
    
    if (rawTag && rawTag.trim()) {
      const creativeDiv = document.getElementById("creative");
      
      // Debug: Show what we're trying to load
      console.log("Loading tag:", rawTag);
      logNetworkActivity(window.location.href, 'success', 'Tag received for processing');
      
      // Set up monitoring before loading the tag
      setupNetworkMonitoring();
      
      // Create a safe way to inject and execute the tag
      function loadTag(tagContent) {
        // For CM360 tags with dcmads.js, we need special handling
        if (tagContent.includes('dcmads.js') || tagContent.includes('class=\'dcmads\'') || tagContent.includes('class="dcmads"')) {
          logNetworkActivity('CM360', 'success', 'Detected CM360 dcmads tag format');
          
          // Create a container for the tag
          const tagContainer = document.createElement('div');
          tagContainer.style.cssText = 'border: 2px dashed #0055A4; padding: 10px; margin-top: 10px;';
          tagContainer.innerHTML = '<strong>CM360 Creative:</strong><br><br>';
          
          // Insert the tag content
          const tagElement = document.createElement('div');
          tagElement.innerHTML = tagContent;
          tagContainer.appendChild(tagElement);
          creativeDiv.appendChild(tagContainer);
          
          // Monitor for iframe creation with more persistence
          let checkCount = 0;
          const checkForIframe = () => {
            checkCount++;
            
            // Check for iframes anywhere in the document, not just in creativeDiv
            const allIframes = document.querySelectorAll('iframe');
            const dcmIframe = Array.from(allIframes).find(iframe => 
              iframe.src && (
                iframe.src.includes('doubleclick.net') || 
                iframe.src.includes('googleadservices.com') ||
                iframe.closest('.dcmads') ||
                iframe.getAttribute('data-dcm-placement')
              )
            );
            
            // Also check if any iframe was added to our creative container
            const creativeIframe = creativeDiv.querySelector('iframe');
            const targetIframe = dcmIframe || creativeIframe;
            
            if (targetIframe) {
              logNetworkActivity(targetIframe.src || 'iframe-found', 'success', `CM360 iframe found (attempt ${checkCount})`);
              
              // Style the iframe container
              tagContainer.style.border = '2px solid #4CAF50';
              tagContainer.querySelector('strong').textContent = 'CM360 Creative (Iframe Found):';
              
              // Make sure iframe is visible and properly sized
              targetIframe.style.display = 'block';
              targetIframe.style.width = '300px';
              targetIframe.style.height = '250px';
              targetIframe.style.border = '1px solid #ccc';
              
              // Monitor the iframe source for pixel patterns
              if (targetIframe.src) {
                checkPixelUrl(targetIframe.src);
                logNetworkActivity(targetIframe.src, 'success', 'Monitoring iframe src for pixels');
              }
              
              // Listen for iframe load
              targetIframe.onload = function() {
                logNetworkActivity(targetIframe.src || 'iframe', 'success', 'CM360 iframe content loaded');
                tagContainer.querySelector('strong').textContent = 'CM360 Creative (Fully Loaded):';
                tagContainer.style.border = '2px solid #4CAF50';
                
                // Try to inspect iframe content after load (will likely fail due to CORS)
                setTimeout(() => {
                  try {
                    if (targetIframe.contentDocument) {
                      const iframeDoc = targetIframe.contentDocument;
                      logNetworkActivity('iframe-content', 'success', 'Iframe content accessible');
                      
                      // Scan for pixels in iframe content
                      const iframeScripts = iframeDoc.querySelectorAll('script[src]');
                      const iframeImages = iframeDoc.querySelectorAll('img[src]');
                      const iframeLinks = iframeDoc.querySelectorAll('a[href]');
                      
                      iframeScripts.forEach(script => {
                        logNetworkActivity(script.src, 'success', 'Iframe script found');
                        checkPixelUrl(script.src);
                      });
                      
                      iframeImages.forEach(img => {
                        logNetworkActivity(img.src, 'success', 'Iframe image found');
                        checkPixelUrl(img.src);
                      });
                      
                      iframeLinks.forEach(link => {
                        if (link.href.includes('pixel') || link.href.includes('tracking')) {
                          logNetworkActivity(link.href, 'success', 'Iframe tracking link found');
                          checkPixelUrl(link.href);
                        }
                      });
                    }
                  } catch (e) {
                    logNetworkActivity('iframe-content', 'error', `Cannot access iframe content: ${e.message}`);
                  }
                }, 500);
              };
              
              targetIframe.onerror = function() {
                logNetworkActivity(targetIframe.src, 'error', 'CM360 iframe failed to load');
                tagContainer.style.border = '2px solid #F44336';
                tagContainer.querySelector('strong').textContent = 'CM360 Creative (Iframe Error):';
              };
              
            } else if (checkCount < 20) { // Check for 10 seconds
              logNetworkActivity('iframe-check', 'success', `Checking for iframe... (${checkCount}/20)`);
              setTimeout(checkForIframe, 500);
            } else {
              // No iframe found after 10 seconds
              logNetworkActivity('CM360', 'error', 'Timeout: No iframe created by dcmads.js after 10 seconds');
              tagContainer.style.border = '2px solid #F44336';
              tagContainer.querySelector('strong').textContent = 'CM360 Creative (Failed - No iframe):';
              
              // Additional debugging
              const dcmScript = document.querySelector('script[src*="dcmads.js"]');
              const dcmElements = document.querySelectorAll('.dcmads');
              
              logNetworkActivity('debug', 'error', `dcmads.js script found: ${!!dcmScript}`);
              logNetworkActivity('debug', 'error', `dcmads elements found: ${dcmElements.length}`);
              logNetworkActivity('debug', 'error', `Total iframes in document: ${document.querySelectorAll('iframe').length}`);
            }
          };
          
          // Start checking for iframe after a brief delay
          setTimeout(checkForIframe, 1000);
          
        } else if (tagContent.includes('<script')) {
          // Handle other script-based tags
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = tagContent;
          
          const tagContainer = document.createElement('div');
          tagContainer.style.cssText = 'border: 2px dashed #0055A4; padding: 10px; margin-top: 10px;';
          tagContainer.innerHTML = '<strong>Script-based Creative:</strong><br><br>';
          
          // Move all content to the creative div
          while (tempDiv.firstChild) {
            const child = tempDiv.firstChild;
            if (child.tagName === 'SCRIPT') {
              // Create new script element to ensure execution
              const newScript = document.createElement('script');
              if (child.src) {
                newScript.src = child.src;
                newScript.async = child.async;
                newScript.defer = child.defer;
                newScript.onload = () => logNetworkActivity(child.src, 'success', 'External script loaded');
                newScript.onerror = () => logNetworkActivity(child.src, 'error', 'External script failed to load');
              } else {
                newScript.textContent = child.textContent;
              }
              tagContainer.appendChild(newScript);
              logNetworkActivity(child.src || 'inline', 'success', 'Script tag processed');
            } else {
              tagContainer.appendChild(child);
            }
            tempDiv.removeChild(tempDiv.firstChild);
          }
          
          creativeDiv.appendChild(tagContainer);
        } else {
          // For non-script content, direct innerHTML works
          const tagContainer = document.createElement('div');
          tagContainer.style.cssText = 'border: 2px dashed #0055A4; padding: 10px; margin-top: 10px;';
          tagContainer.innerHTML = '<strong>Static Creative:</strong><br><br>' + tagContent;
          creativeDiv.appendChild(tagContainer);
        }
        
        logNetworkActivity('DOM', 'success', 'Creative content processed');
      }
      
      // Load the tag
      try {
        loadTag(rawTag);
        
      } catch (error) {
        console.error("Error loading tag:", error);
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'background: #FFEBEE; border: 1px solid #F44336; padding: 10px; border-radius: 5px; color: #C9302C; margin-top: 10px;';
        errorDiv.innerHTML = `❌ Error loading tag: ${error.message}`;
        document.getElementById("creative").appendChild(errorDiv);
        logNetworkActivity('Error', 'error', `Tag loading failed: ${error.message}`);
      }
      
      // Scan for existing elements after a short delay
      setTimeout(() => {
        scanExistingElements();
        
        // Mark any remaining as not fired after 8 seconds
        setTimeout(() => {
          expectedPixels.forEach(pixel => {
            if (pixelStatus[pixel.name] === 'pending') {
              pixelStatus[pixel.name] = 'not-fired';
              const el = document.getElementById(`pixel-${pixel.name.replace(/[^a-zA-Z0-9]/g, '')}`);
              if (el) {
                el.className = "pixel-check not-fired";
                el.textContent = `❌ ${pixel.name}: Timeout/Not detected`;
              }
            }
          });
          updateStats();
        }, 8000);
      }, 2000);
      
    } else {
      document.getElementById("creative").innerHTML += "<p style='color: #C9302C; text-align: center; padding: 20px;'>❌ No tag content received or tag is empty.</p>";
    }

    function goBack() { 
      window.location.href = "index.html"; 
    }

    // Monitor for dynamically created elements
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        mutation.addedNodes.forEach(function(node) {
          if (node.nodeType === 1) { // Element node
            if (node.tagName === 'IMG' && node.src) {
              checkPixelUrl(node.src);
            } else if (node.tagName === 'IFRAME' && node.src) {
              checkPixelUrl(node.src);
            } else if (node.tagName === 'SCRIPT' && node.src) {
              checkPixelUrl(node.src);
            }
            
            // Check child elements too
            const imgs = node.querySelectorAll ? node.querySelectorAll('img[src]') : [];
            const iframes = node.querySelectorAll ? node.querySelectorAll('iframe[src]') : [];
            const scripts = node.querySelectorAll ? node.querySelectorAll('script[src]') : [];
            
            imgs.forEach(img => checkPixelUrl(img.src));
            iframes.forEach(iframe => checkPixelUrl(iframe.src));
            scripts.forEach(script => checkPixelUrl(script.src));
          }
        });
      });
    });

    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
  </script>
</body>
</html>
